{% extends "base.html" %}
{% block content %}
<div class="container">

  <!-- Page title -->
  <div class="page-title" style="margin-bottom:24px;">
    üìä Strategy Analyzer ‚Äì Upload & Analyze
  </div>

  <!-- Upload + Controls -->
  <div class="grid" style="gap:20px; margin-bottom:24px;">

    <!-- Upload card -->
    <section class="card">
      <div class="card-header">Upload Backtests</div>
      <div class="card-sub">
        Upload one or many NinjaTrader <code>.xlsx</code> exports. We‚Äôll cache them so you can change
        views and filters without re-uploading.
      </div>
      <div class="card-body">
        <form action="{{ url_for('main.upload') }}" method="post" enctype="multipart/form-data">
          <p>
            <input type="file" name="file" accept=".xlsx" multiple />
          </p>

          <!-- Chart settings used on first upload -->
          <div class="hr"></div>
          <p class="help" style="margin-bottom:8px;">Initial chart settings (you can change these later in Live Controls):</p>

          <div class="toggle-group" style="margin-bottom:10px;">
            <label class="toggle">
              <input type="checkbox" name="show_total"
                     {% if settings and settings.show_total %}checked{% endif %}>
              <span>Show Total PnL (one line)</span>
            </label>

            <label class="toggle">
              <input type="checkbox" name="by_dates"
                     {% if settings and settings.by_dates %}checked{% endif %}>
              <span>X-Axis by Dates (unchecked = Trades)</span>
            </label>
          </div>

          <div class="toggle-group" style="margin-bottom:10px;">
            <span class="help" style="margin-right:6px;">Trade filter:</span>

            <label class="toggle">
              <input type="radio" name="trade_filter" value="all"
                     {% if not settings or settings.trade_filter == 'all' %}checked{% endif %}>
              <span>All</span>
            </label>

            <label class="toggle">
              <input type="radio" name="trade_filter" value="long"
                     {% if settings and settings.trade_filter == 'long' %}checked{% endif %}>
              <span>Long</span>
            </label>

            <label class="toggle">
              <input type="radio" name="trade_filter" value="short"
                     {% if settings and settings.trade_filter == 'short' %}checked{% endif %}>
              <span>Short</span>
            </label>
          </div>

          <button type="submit" class="btn">Upload & Analyze</button>

          {% if error %}
            <p style="color:#ffb4c4;margin-top:10px;">{{ error }}</p>
          {% endif %}
        </form>
      </div>
    </section>

    {% if names and names|length %}
    <!-- Live controls card (no re-upload needed) -->
    <section class="card">
      <div class="card-header">Live Controls</div>
      <div class="card-sub">
        Change how the chart is drawn without re-uploading. These settings update the portfolio
        summary, chart, correlation, and per-strategy metrics.
      </div>
      <div class="card-body">
        <form action="{{ url_for('main.render_from_cache') }}" method="post" id="controls-form">

          <!-- Toggles for chart behaviour -->
          <div class="toggle-group" style="margin-bottom:10px;">
            <label class="toggle">
              <input type="checkbox" name="show_total"
                     {% if settings and settings.show_total %}checked{% endif %}>
              <span>Show Total PnL (one line)</span>
            </label>

            <label class="toggle">
              <input type="checkbox" name="by_dates"
                     {% if settings and settings.by_dates %}checked{% endif %}>
              <span>X-Axis by Dates</span>
            </label>
          </div>

          <div class="toggle-group" style="margin-bottom:14px;">
            <span class="help" style="margin-right:6px;">Trade filter:</span>

            <label class="toggle">
              <input type="radio" name="trade_filter" value="all"
                     {% if settings and settings.trade_filter == 'all' %}checked{% endif %}>
              <span>All</span>
            </label>

            <label class="toggle">
              <input type="radio" name="trade_filter" value="long"
                     {% if settings and settings.trade_filter == 'long' %}checked{% endif %}>
              <span>Long</span>
            </label>

            <label class="toggle">
              <input type="radio" name="trade_filter" value="short"
                     {% if settings and settings.trade_filter == 'short' %}checked{% endif %}>
              <span>Short</span>
            </label>
          </div>

          <!-- Dataset selection -->
          <div class="hr"></div>
          <p class="help" style="margin-bottom:6px;">Datasets to include in portfolio & metrics:</p>

          <div style="margin-bottom:8px;">
            <button type="button" class="btn" style="padding:6px 10px;font-size:13px;"
                    onclick="checkAll(true)">Select all</button>
            <button type="button" class="btn" style="padding:6px 10px;font-size:13px;"
                    onclick="checkAll(false)">Select none</button>
          </div>

          <div class="list">
            {% for n in names %}
              <label class="list-item">
                <input type="checkbox" name="include" value="{{ n }}"
                       {% if n in selected %}checked{% endif %}>
                <span>{{ n }}</span>
              </label>
            {% endfor %}
          </div>

          <div style="margin-top:14px;">
            <button type="submit" class="btn">Apply View</button>
          </div>
        </form>

        <script>
          function checkAll(state){
            document.querySelectorAll('#controls-form input[name="include"]')
              .forEach(cb => cb.checked = state);
          }
        </script>
      </div>
    </section>
    {% endif %}
  </div>

  {% if result %}
  <!-- CHARTS & METRICS LAYOUT -->
  <!-- Portfolio Summary (before charts) -->
  <section class="card" style="margin-bottom:24px;">
    <div class="card-header">Portfolio Summary</div>
    <div class="card-sub">
      Showing <b>Total PnL</b> (if enabled), X-Axis = <b>{{ 'Dates' if settings.by_dates else 'Trades' }}</b>,
      Trade Filter = <b>{{ settings.trade_filter|capitalize }}</b>.
    </div>

    <div class="card-body">
      <table class="table">
        <tbody>
          <tr><th>Profits</th><td>${{ '{:,.2f}'.format(result.portfolio_profits) }}</td></tr>
          <tr><th>Backtest</th><td>{{ result.start }} ‚Üí {{ result.end }}</td></tr>
          <tr><th>CAGR</th><td>{{ '{:.2%}'.format(result.cagr) }}</td></tr>
          <tr><th>Trades</th><td>{{ result.total_trades }}</td></tr>
          <tr><th>Win Rate</th><td>{{ '{:.2f}%'.format(result.win_rate) }}</td></tr>
          <tr><th>Sharpe</th><td>{{ '{:.2f}'.format(result.sharpe) }}</td></tr>
          <tr><th>Sortino</th><td>{{ '{:.2f}'.format(result.sortino) }}</td></tr>
          <tr><th>Max Drawdown</th><td>${{ '{:,.2f}'.format(result.max_drawdown) }}</td></tr>
          <tr><th>Largest Loss</th><td>${{ '{:,.2f}'.format(result.largest_loss) }}</td></tr>
          <tr><th>Required Capital</th><td>${{ '{:,.2f}'.format(result.required_capital) }}</td></tr>
          <tr><th>Strategies</th>
            <td>{{ result.strategies | join(', ') }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <div class="grid-charts">

    <!-- Row 1: Main PnL Chart full width -->
    <section class="card chart-wide">
      <div class="card-header">Main PnL Chart</div>
      <div class="card-sub">
        Cumulative equity curve based on selected datasets, filters, and ‚ÄúTotal vs individual lines‚Äù settings.
      </div>
      <div class="card-body">
        <div class="plot-box">
          {{ charts.pnl | safe }}
        </div>
      </div>
    </section>

    <!-- ML Pipeline Assistant (LLM) -->
    <section id="ml-pipeline-assistant" class="card" style="padding:24px;">
      <h2 style="margin-bottom:12px;">ML Pipeline Assistant</h2>

      <p style="margin-bottom:20px;">
        Use this assistant to generate report-ready text for your
        methodology and evaluation sections.
      </p>

      <!-- BUTTONS ROW 1 -->
      <div class="llm-buttons" style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:20px;">
        <button type="button" class="btn" onclick="generateDataPrepText()">
          Generate Data Preparation Text
        </button>

        <button type="button" class="btn" onclick="generateModelTrainingText()">
          Generate Model Training & Testing Text
        </button>

        <button type="button" class="btn" onclick="generateEvalMetricsText()">
          Generate Evaluation Metrics Text
        </button>
      </div>

      <!-- BUTTONS ROW 2 with spacing -->
      <div style="margin-bottom:20px;">
        <button type="button" class="btn" onclick="generateFeatureSelectionText()">
          Generate Feature Selection / Tuning Text
        </button>
      </div>

      <label for="llm-extra-context" style="font-weight:600;">Extra context (optional):</label>
      <textarea id="llm-extra-context" rows="3"
                style="width:100%; margin-top:6px; margin-bottom:20px; padding:10px;"
                placeholder="Add any notes about your dataset, strategy, or model here..."></textarea>

      <h3 style="margin-bottom:10px;">LLM Output</h3>

      <!-- WIDER OUTPUT BOX -->
      <textarea id="llm-output" rows="12" readonly
                style="width:100%; padding:12px; font-size:15px; line-height:1.5; height:280px;"
                placeholder="Generated text will appear here. You can copy/paste it into your report."></textarea>
    </section>

    <!-- AI Strategy Combo Selector -->
    <section class="card">
      <div class="card-header">AI Strategy Combo Selector</div>
      <div class="card-sub">
        Let the LLM suggest a combination of strategies that balances net profit and low drawdown.
      </div>
      <div class="card-body">
        <div style="margin-bottom:8px;">
          <label for="max-strategies" class="help" style="margin-right:6px;">
            Max number of strategies to include:
          </label>
          <input id="max-strategies" type="number" min="1" value="3"
                 style="width:60px; padding:4px;">
        </div>

        <button type="button" class="btn" onclick="generateStrategyCombo()">
          Suggest Strategy Combination
        </button>

        <div style="margin-top:12px;">
          <h4>Selected Strategies (AI)</h4>
          <pre id="strategy-combo-names" style="white-space:pre-wrap;"></pre>
        </div>

        <div style="margin-top:8px;">
          <h4>AI Rationale</h4>
          <textarea id="strategy-combo-rationale" rows="6" readonly
                    style="width:100%;"></textarea>
        </div>
      </div>
    </section>

    <!-- Row 2, left: Correlation -->
    <section class="card">
      <div class="card-header">Correlation Matrix</div>
      <div class="card-sub">Daily PnL correlations between the selected strategies.</div>
      <div class="card-body">
        <div class="plot-box">
          {% if charts.correlation %}
            {{ charts.correlation | safe }}
          {% else %}
            <p class="help">Select at least two datasets to see correlation.</p>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Row 2, right: Per-strategy metrics -->
    <section class="card">
      <div class="card-header">Per-Strategy Metrics</div>
      <div class="card-sub">
        Metrics are computed after applying filters and dataset selection.
      </div>
      <div class="card-body" style="overflow:auto; max-height:520px;">
        {% if per_strategy and per_strategy|length %}
          <table class="table">
            <thead>
              <tr>
                <th>Strategy</th>
                <th style="text-align:right">Net Profit</th>
                <th style="text-align:right">Trades</th>
                <th style="text-align:right">Win Rate</th>
                <th style="text-align:right">Avg Trade</th>
                <th style="text-align:right">Avg Win</th>
                <th style="text-align:right">Avg Loss</th>
                <th style="text-align:right">Largest Win</th>
                <th style="text-align:right">Largest Loss</th>
              </tr>
            </thead>
            <tbody>
              {% for r in per_strategy %}
              <tr>
                <td>{{ r.name }}</td>
                <td style="text-align:right">${{ '{:,.2f}'.format(r.profit) }}</td>
                <td style="text-align:right">{{ r.trades }}</td>
                <td style="text-align:right">{{ '{:.2f}%'.format(r.win_rate) }}</td>
                <td style="text-align:right">${{ '{:,.2f}'.format(r.avg) }}</td>
                <td style="text-align:right">${{ '{:,.2f}'.format(r.avg_win) }}</td>
                <td style="text-align:right">${{ '{:,.2f}'.format(r.avg_loss) }}</td>
                <td style="text-align:right">${{ '{:,.2f}'.format(r.max_win) }}</td>
                <td style="text-align:right">${{ '{:,.2f}'.format(r.max_loss) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="help">No strategies to show.</p>
        {% endif %}
      </div>
    </section>

    <!-- ======================= ML RESULTS CARD ======================= -->
    <section class="card" style="margin-top:24px;">
      <div class="card-header">ML Model Evaluation Results</div>
      <div class="card-sub">
        Accuracy, Precision, Recall, F1 Score, and Confusion Matrix for the trade classifier.
      </div>

      <div class="card-body">

        <h3>Metrics</h3>
        <table class="table" style="margin-bottom:20px; max-width:420px;">
          <tbody>
            <tr><th>Accuracy</th><td id="ml-acc">‚Äì</td></tr>
            <tr><th>Precision</th><td id="ml-prec">‚Äì</td></tr>
            <tr><th>Recall</th><td id="ml-rec">‚Äì</td></tr>
            <tr><th>F1 Score</th><td id="ml-f1">‚Äì</td></tr>
          </tbody>
        </table>

        <h3>Confusion Matrix</h3>
        <div id="ml-confusion" style="width:420px; height:420px;">
          <p class="help">Confusion matrix will appear here.</p>
        </div>

        <button class="btn" onclick="loadMlResults()" style="margin-top:20px;">
          Load ML Evaluation Metrics
        </button>

      </div>
    </section>


  </div>
  {% endif %}
</div>

<script>
const STRATEGY_METRICS = {{ strategy_metrics | tojson | safe }};

async function callLLM(endpoint, payload, outputId) {
  const outputEl = document.getElementById(outputId);
  if (outputEl) {
    outputEl.value = "Generating with LLM...";
  }

  try {
    const response = await fetch(endpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    const data = await response.json();

    if (!data.ok) {
      if (outputEl) {
        outputEl.value = "Error from LLM: " + (data.error || "Unknown error");
      }
      return;
    }

    if (outputEl) {
      outputEl.value = data.text || data.raw_text || "(No text returned from LLM)";
    }
  } catch (err) {
    if (outputEl) {
      outputEl.value = "Request failed: " + err;
    }
  }
}

function getExtraContext() {
  const el = document.getElementById("llm-extra-context");
  return el ? el.value : "";
}

async function generateDataPrepText() {
  const payload = {
    columns: ["profit", "entry_time", "exit_time", "market_position"],
    steps: [
      "normalized profit values",
      "encoded market_position as long/short",
      "derived trade_duration from entry/exit timestamps"
    ],
    extra_context: getExtraContext()
  };

  await callLLM("/api/llm/data_preparation", payload, "llm-output");
}

async function generateModelTrainingText() {
  const payload = {
    target: "profitable_trade (binary: win vs non-win)",
    features: [
      "normalized profit",
      "trade_duration",
      "market_position_long",
      "market_position_short"
    ],
    model_type: "Logistic Regression",
    train_test_split: "80/20 train-test split with fixed random_state",
    extra_context: getExtraContext()
  };

  await callLLM("/api/llm/model_training", payload, "llm-output");
}

async function generateEvalMetricsText() {
  const payload = {
    metrics: {
      accuracy: 0.87,
      precision: 0.82,
      recall: 0.79,
      f1: 0.80
    },
    confusion_matrix: [
      [50, 10],
      [8, 32]
    ],
    labels: ["non_profitable_or_break_even", "profitable"],
    extra_context: getExtraContext()
  };

  await callLLM("/api/llm/eval_metrics", payload, "llm-output");
}

async function generateFeatureSelectionText() {
  const payload = {
    all_features: [
      "profit_norm",
      "trade_duration",
      "max_adverse_excursion",
      "max_favorable_excursion",
      "session_time",
      "volatility"
    ],
    target: "profitable_trade",
    model_type: "Logistic Regression",
    extra_context: getExtraContext()
  };

  await callLLM("/api/llm/feature_selection", payload, "llm-output");
}

async function generateStrategyCombo() {
  const maxStratsInput = document.getElementById("max-strategies");
  let maxStrats = 3;

  if (maxStratsInput && maxStratsInput.value) {
    maxStrats = parseInt(maxStratsInput.value, 10);
    if (isNaN(maxStrats) || maxStrats < 1) {
      maxStrats = 3;
    }
  }

  const namesEl = document.getElementById("strategy-combo-names");
  const rationaleEl = document.getElementById("strategy-combo-rationale");

  // Basic guard: if no strategies, show message
  if (!Array.isArray(STRATEGY_METRICS) || STRATEGY_METRICS.length === 0) {
    if (namesEl) namesEl.textContent = "No strategy metrics available.";
    if (rationaleEl) rationaleEl.value = "";
    return;
  }

  if (namesEl) namesEl.textContent = "Asking LLM for best combo...";
  if (rationaleEl) rationaleEl.value = "";

  try {
    const response = await fetch("/api/llm/strategy_combo", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        strategies: STRATEGY_METRICS,
        max_strategies: maxStrats
      })
    });

    const data = await response.json();

    if (!data.ok) {
      if (namesEl) namesEl.textContent = "Error: " + (data.error || "Unknown error");
      return;
    }

    // Handle parsed JSON selection or raw text fallback
    if (data.selection && Array.isArray(data.selection.selected_strategies)) {
      const selected = data.selection.selected_strategies;
      const rationale = data.selection.rationale || "";

      // Nice bullet list for selected strategies
      if (namesEl) {
        if (selected.length) {
          namesEl.textContent = selected.map(name => "‚Ä¢ " + name).join("\n");
        } else {
          namesEl.textContent = "(No strategies selected)";
        }
      }

      // Plain paragraph rationale
      if (rationaleEl) {
        rationaleEl.value = rationale;
      }
    } else if (data.raw_text) {
      // Fallback: try to strip ```json fences for display
      let raw = data.raw_text.trim();
      if (raw.startsWith("```")) {
        raw = raw.replace(/^```(?:json)?\s*/i, "");
        if (raw.includes("```")) {
          raw = raw.split("```", 1)[0];
        }
        raw = raw.trim();
      }
      if (namesEl) {
        namesEl.textContent = "(LLM did not return structured JSON; see rationale)";
      }
      if (rationaleEl) {
        rationaleEl.value = raw;
      }
    } else {
      if (namesEl) namesEl.textContent = "Unexpected response from LLM.";
    }
  } catch (err) {
    if (namesEl) namesEl.textContent = "Request failed: " + err;
  }
}
async function loadMlResults() {
  // Replace this with real test results
  const payload = {
    y_true: [1,0,1,1,0,1,0,0,1,1], 
    y_pred: [1,0,1,0,0,1,0,0,1,1]
  };

  const res = await fetch("/api/ml/evaluate", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  if (!data.ok) {
    alert("ML evaluation failed: " + data.error);
    return;
  }

  // Insert metrics
  document.getElementById("ml-acc").textContent = data.metrics.accuracy.toFixed(3);
  document.getElementById("ml-prec").textContent = data.metrics.precision.toFixed(3);
  document.getElementById("ml-rec").textContent = data.metrics.recall.toFixed(3);
  document.getElementById("ml-f1").textContent = data.metrics.f1.toFixed(3);

  // Plot confusion matrix (Plotly)
  const cm = data.confusion_matrix;
  const trace = {
    z: cm,
    x: ["Pred 0","Pred 1"],
    y: ["True 0","True 1"],
    type: "heatmap",
    colorscale: "Blues",
    showscale: true
  };

  const layout = {
    title: "Confusion Matrix",
    xaxis: {side: "top"},
    yaxis: {autorange: "reversed"}
  };

  Plotly.newPlot("ml-confusion", [trace], layout);
}
</script>

{% endblock %}
